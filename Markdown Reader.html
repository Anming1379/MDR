<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Markdown Reader</title>

<!-- ä¾èµ–ï¼ˆCDNï¼‰-->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>

<style>
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --text:#1e1f24; --muted:#636a75; --border:#e7e9ef;
    --accent:#4c7dff; --accent-weak:#e8efff;
    --code-bg:#0d1117; --code-fg:#c9d1d9;
    --radius:14px; --gap:18px; --sidebar-w:300px; --content-max:980px;
    --shadow:0 10px 30px rgba(22,31,61,0.08);
    --toc-gray-1: #212327; --toc-gray-2: #454b55; --toc-gray-3: #6f7580; --toc-gray-4: #9aa0aa;
  }
  [data-theme="dark"]{
    --bg:#0f131a; --panel:#121823; --text:#eef1f6; --muted:#a5adbb; --border:#1b2230;
    --accent:#7aa2f7; --accent-weak:#1a2336;
    --code-bg:#0b0f16; --code-fg:#e6edf3;
    --shadow:0 10px 30px rgba(0,0,0,0.35);
    --toc-gray-1: #eef1f6; --toc-gray-2: #c3c9d2; --toc-gray-3: #9aa0ab; --toc-gray-4: #737a84;
  }

  html,body{height:100%;margin:0}
  html{scroll-behavior:smooth}
  body{
    display:flex;min-height:100vh;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  .sidebar{width:var(--sidebar-w);min-width:240px;background:var(--panel);
    border-right:1px solid var(--border);padding:14px;box-sizing:border-box;overflow:auto;}
  .sidebar-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .logo{font-weight:800;letter-spacing:.3px}
  .close-btn{display:none;border:0;background:transparent;color:var(--muted);font-size:20px;cursor:pointer}

  .file-tree{font-size:14px;line-height:1.7}
  .folder,.file{cursor:pointer;user-select:none;padding:6px 10px;border-radius:10px;
    transition:background .15s ease,color .15s ease;}
  .folder:hover,.file:hover{background:var(--accent-weak)}
  .folder .title{font-weight:700;color:var(--accent)}
  .file.selected{background:linear-gradient(90deg,var(--accent-weak),transparent);font-weight:700}
  .children{padding-left:12px;margin-top:4px;border-left:2px dashed var(--border)}

  .main{flex:1;display:flex;flex-direction:column;padding:20px;box-sizing:border-box;overflow:auto}
  .toolbar{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
  .mobile-toggle{display:none;border:1px solid var(--border);padding:8px 12px;border-radius:10px;background:var(--panel);
    color:var(--text);cursor:pointer;}
  .search{flex:1;min-width:200px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);
    color:var(--text);outline:none;}
  .meta{min-width:160px;color:var(--muted);font-size:13px}
  .theme-switch{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);
    border-radius:12px;padding:8px 10px;color:var(--muted);cursor:pointer;}

  .layout{display:flex;gap:var(--gap);align-items:flex-start;flex-wrap:wrap}
  .content{flex:1 1 640px;min-width:300px;max-width:var(--content-max);width:100%;
    margin:0 auto;background:var(--panel);padding:28px;border-radius:var(--radius);box-shadow:var(--shadow);
    box-sizing:border-box;}
  .aside{width:320px;min-width:240px;}

  .aside-card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:0;display:flex;flex-direction:column;position:fixed;top:16px;right:16px;width:320px;
    max-height:70vh;overflow:hidden;z-index:30;}
  .toc-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--panel);}
  .toc-title{font-weight:800}
  .toc-toggle{border:1px solid var(--border);background:var(--panel);color:var(--muted);border-radius:10px;padding:6px 10px;cursor:pointer;}
  .toc{padding:10px 12px;overflow:auto;flex:1}
  .aside-card.collapsed .toc{display:none}
  .aside-card.collapsed{max-height:auto}

  .content h1{text-align:center;margin-top:0;margin-bottom:.2em;font-size:2.0rem;line-height:1.25}
  .content h2,.content h3,.content h4,.content h5,.content h6{text-align:left;margin:1.25em 0 .6em;color:var(--text)}
  .content p,.content li,.content pre,.content blockquote{text-align:left}
  .content p{color:var(--text);line-height:1.85;margin:.8em 0}
  .content a{color:var(--accent);text-decoration:none}
  .content a:hover{text-decoration:underline}
  .content img{max-width:100%;border-radius:10px}

  .content blockquote{margin:1em 0;padding:10px 14px;border-left:4px solid var(--accent);background:var(--accent-weak);color:var(--text);border-radius:10px;}
  .content hr{border:none;border-top:1px solid var(--border);margin:22px 0}
  .content ul,.content ol{padding-left:1.3em}
  .content li{margin:.35em 0}
  .content table{border-collapse:collapse;width:100%}
  .content th,.content td{border:1px solid var(--border);padding:10px;text-align:left}
  .content thead th{background:var(--accent-weak);font-weight:700}
  .content pre{background:var(--code-bg);color:var(--code-fg);padding:14px;border-radius:12px;overflow:auto}
  .content code{background:rgba(76,125,255,0.12);color:var(--text);padding:2px 6px;border-radius:8px}
  .content pre code{background:transparent;color:inherit;padding:0;border-radius:0}

  .toc a{display:block;text-decoration:none;padding:6px 8px;border-radius:10px;position:relative;color:var(--toc-gray-2)}
  .toc .level-1{padding-left:6px;color:var(--toc-gray-1);font-weight:700}
  .toc .level-2{padding-left:10px;color:var(--toc-gray-2)}
  .toc .level-3{padding-left:24px;color:var(--toc-gray-3)}
  .toc .level-4{padding-left:38px;color:var(--toc-gray-4)}
  .toc a:hover{background:var(--accent-weak);color:var(--text)}
  .toc a.active{background:var(--accent-weak);color:var(--text);font-weight:700;box-shadow:inset 0 0 0 1px var(--border)}
  .toc .level-3::before,.toc .level-4::before{content:"";position:absolute;left:10px;top:50%;width:10px;height:1px;background:var(--border)}

  .toc-fab{display:none;position:fixed;right:16px;bottom:16px;z-index:36;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);cursor:pointer}
  .toc-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.25);z-index:34}

  @media (max-width:980px){
    body{flex-direction:column}
    .sidebar{position:fixed;left:-110%;top:0;bottom:0;z-index:40;box-shadow:var(--shadow);transition:left .22s ease}
    .sidebar.open{left:0}
    .close-btn{display:inline-block}
    .mobile-toggle{display:inline-block}
    .main{padding:16px}
    .aside{width:100%;min-width:auto}

    .toc-toggle{display:none}
    .toc-fab{display:inline-block}
    .toc-backdrop{display:none}

    .aside-card{
      position:fixed;top:0;bottom:0;right:0;left:auto;
      width:86vw;max-width:400px;max-height:none;
      transform:translateX(100%);transition:transform .22s ease;
      overflow:hidden;z-index:35;
    }
    .aside-card .toc{height:100%;padding:12px}
    .aside-card.open{transform:translateX(0)}
    .toc-backdrop.open{display:block}
  }

  .toc-fab{ z-index:36 !important; }
  .aside-card{ z-index:35 !important; }
  .toc-backdrop{ z-index:34 !important; }
  .aside-card.open{ transform:translateX(0) !important; opacity:1 !important; pointer-events:auto !important; }
</style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">æ–‡ä»¶</div>
      <button id="closeSidebar" class="close-btn" title="å…³é—­">Ã—</button>
    </div>

    <div style="display:flex;gap:8px;flex-direction:column">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="filePicker" type="file" webkitdirectory directory multiple style="display:none" />
        <button id="pickBtn" class="theme-switch" title="é€‰æ‹©æ–‡ä»¶æˆ–ç›®å½•">é€‰æ‹©æ–‡ä»¶/ç›®å½•</button>
        <button id="clearBtn" class="theme-switch" title="æ¸…ç©º">æ¸…ç©º</button>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">æ”¯æŒæ‹–æ”¾ç›®å½•æˆ–ä½¿ç”¨æŒ‰é’®é€‰æ‹©ã€‚ç°ä»£æµè§ˆå™¨å¯è¯»å–æ–‡ä»¶å¤¹ã€‚</div>
    </div>

    <div style="height:12px"></div>
    <input id="search" class="search" placeholder="æœç´¢æ–‡ä»¶æˆ–æ–‡æœ¬â€¦" />
    <div style="height:10px"></div>
    <div class="file-tree" id="fileTree">å°šæœªåŠ è½½æœ¬åœ°æ–‡ä»¶</div>
  </aside>

  <main class="main">
    <div class="toolbar">
      <button id="openSidebar" class="mobile-toggle">æ–‡æœ¬</button>
      <div class="meta">çº¯å‰ç«¯ Markdown æŸ¥çœ‹å™¨</div>
      <button id="themeSwitch" class="theme-switch" title="åˆ‡æ¢ä¸»é¢˜">ä¸»é¢˜</button>
    </div>

    <div class="layout">
      <section class="content" id="content">è¯·é€šè¿‡å·¦ä¾§ã€Œé€‰æ‹©æ–‡ä»¶/ç›®å½•ã€æˆ–æ‹–æ”¾ Markdown æ–‡ä»¶åˆ°æ­¤é¡µé¢</section>
      <aside class="aside">
        <div class="aside-card" id="tocCard" aria-expanded="true">
          <div class="toc-header">
            <div class="toc-title">ç›®å½•</div>
            <button id="tocToggle" class="toc-toggle" aria-controls="toc" aria-label="æ”¶èµ·ç›®å½•">æ”¶èµ·</button>
          </div>
          <nav id="toc" class="toc">å½“å‰æœªåŠ è½½</nav>
        </div>
      </aside>
    </div>
  </main>

  <button id="tocFab" class="toc-fab" aria-label="æ‰“å¼€ç›®å½•">ç›®å½•</button>
  <div id="tocBackdrop" class="toc-backdrop" aria-hidden="true"></div>

<script>
/* çº¯å‰ç«¯è„šæœ¬ï¼šæ–‡ä»¶é€‰æ‹©ã€æ‹–æ”¾ã€File System Access æ”¯æŒã€æ¸²æŸ“ Markdownã€æ„å»º TOC */
(() => {
  const fileTreeEl = document.getElementById('fileTree');
  const contentEl = document.getElementById('content');
  const tocEl = document.getElementById('toc');
  const searchEl = document.getElementById('search');
  const sidebar = document.getElementById('sidebar');
  const openSidebar = document.getElementById('openSidebar');
  const closeSidebar = document.getElementById('closeSidebar');
  const themeSwitch = document.getElementById('themeSwitch');
  const pickBtn = document.getElementById('pickBtn');
  const filePicker = document.getElementById('filePicker');
  const clearBtn = document.getElementById('clearBtn');

  const tocCard = document.getElementById('tocCard');
  const tocToggle = document.getElementById('tocToggle');
  const tocFab = document.getElementById('tocFab');
  const tocBackdrop = document.getElementById('tocBackdrop');

  openSidebar && openSidebar.addEventListener('click', ()=> sidebar.classList.toggle('open'));
  closeSidebar && closeSidebar.addEventListener('click', ()=> sidebar.classList.remove('open'));

  const root = document.documentElement;
  const savedTheme = localStorage.getItem('mdviewer-theme');
  if (savedTheme) root.setAttribute('data-theme', savedTheme);
  if (themeSwitch) themeSwitch.addEventListener('click', ()=>{
    const current = root.getAttribute('data-theme') || 'light';
    const next = current === 'light' ? 'dark' : 'light';
    root.setAttribute('data-theme', next);
    localStorage.setItem('mdviewer-theme', next);
  });

  if (localStorage.getItem('mdviewer-toc-collapsed') === 'true' && tocCard) tocCard.classList.add('collapsed');
  tocToggle && tocToggle.addEventListener('click', ()=>{
    if (!tocCard) return;
    const collapsed = tocCard.classList.toggle('collapsed');
    tocCard.setAttribute('aria-expanded', String(!collapsed));
    tocToggle.textContent = collapsed ? 'å±•å¼€' : 'æ”¶èµ·';
    localStorage.setItem('mdviewer-toc-collapsed', String(collapsed));
  });

  function openMobileToc(){ if(!tocCard || !tocBackdrop) return; tocCard.classList.add('open'); tocBackdrop.classList.add('open'); tocBackdrop.setAttribute('aria-hidden','false'); }
  function closeMobileToc(){ if(!tocCard || !tocBackdrop) return; tocCard.classList.remove('open'); tocBackdrop.classList.remove('open'); tocBackdrop.setAttribute('aria-hidden','true'); }
  tocFab && tocFab.addEventListener('click', ()=> { if(!tocCard) return; const isOpen = tocCard.classList.contains('open'); if(isOpen) closeMobileToc(); else openMobileToc(); });
  tocBackdrop && tocBackdrop.addEventListener('click', closeMobileToc);
  window.addEventListener('resize', ()=> {
    if (window.innerWidth > 980) closeMobileToc();
    updateMobileTocVisibility(tocEl && tocEl.children && tocEl.children.length > 0);
  });

  // å­˜å‚¨æ–‡ä»¶ï¼šä»¥ç›¸å¯¹è·¯å¾„ä¸º keyï¼Œå€¼ä¸º {name, path, text}
  const files = new Map();

  // åŠ©æ‰‹ï¼šæŠŠ File å¯¹è±¡æŒ‰è·¯å¾„æ’å…¥ mapï¼ˆæ”¯æŒ file.webkitRelativePathï¼‰
  async function addFilesFromFileList(list) {
    for (const f of list) {
      // åªå¤„ç†æ–‡æœ¬/markdown æ–‡ä»¶æˆ–æ— ç±»å‹ä½†æ‰©å±•åä¸º md/mdown/markdown
      const name = f.name;
      const pathKey = f.webkitRelativePath && f.webkitRelativePath !== '' ? f.webkitRelativePath : name;
      const ext = name.split('.').pop().toLowerCase();
      if (!['md','markdown','mdown','txt'].includes(ext)) continue;
      try {
        const text = await f.text();
        files.set(pathKey.replace(/^\/*/,'').replace(/\\/g,'/'), { name, path: pathKey.replace(/\\/g,'/'), text });
      } catch(e){}
    }
    buildTreeAndRender();
  }

  // File System Access APIï¼šé€’å½’è¯»å–ç›®å½•ï¼ˆå¦‚æœæ”¯æŒï¼‰
  async function addFilesFromDirectoryHandle(dirHandle, base = '') {
    for await (const [name, handle] of dirHandle.entries()) {
      const rel = base ? (base + '/' + name) : name;
      if (handle.kind === 'file') {
        const ext = name.split('.').pop().toLowerCase();
        if (!['md','markdown','mdown','txt'].includes(ext)) continue;
        try {
          const file = await handle.getFile();
          const text = await file.text();
          files.set(rel, { name, path: rel, text });
        } catch(e){}
      } else if (handle.kind === 'directory') {
        await addFilesFromDirectoryHandle(handle, rel);
      }
    }
  }

  // æŒ‰è·¯å¾„æ„å»ºæ ‘çŠ¶æ•°ç»„ [{name,path,type,children}]
  function buildTreeModel() {
    const root = {};
    for (const [p, meta] of files) {
      const parts = p.split('/').filter(Boolean);
      let node = root;
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        if (!node.children) node.children = {};
        if (!node.children[part]) node.children[part] = { name: part, path: parts.slice(0,i+1).join('/'), children: null };
        node = node.children[part];
      }
      node.type = 'file';
      node.text = meta.text;
    }
    // convert to array tree
    function convert(mapNode) {
      if (!mapNode || !mapNode.children) return [];
      return Object.values(mapNode.children).map(n => {
        if (n.children && Object.keys(n.children).length > 0) {
          return { name: n.name, path: n.path, type: 'dir', children: convert(n) };
        } else {
          return { name: n.name, path: n.path, type: n.type === 'file' ? 'file' : 'dir', text: n.text || '' };
        }
      }).sort((a,b)=> {
        if (a.type === b.type) return a.name.localeCompare(b.name, undefined, {sensitivity:'base'});
        return a.type === 'dir' ? -1 : 1;
      });
    }
    return convert({ children: root.children || {} });
  }

  // æ¸²æŸ“æ ‘åˆ° DOMï¼ˆå¤ç”¨åŸæœ‰æ ·å¼ä¸äº¤äº’ï¼‰
  let selectedFileEl = null;
  function renderTree(tree, container = fileTreeEl) {
    if (!container) return;
    container.innerHTML = '';
    if (!tree || tree.length === 0) { container.textContent = 'æœªæ‰¾åˆ° Markdown æ–‡ä»¶'; return; }
    tree.forEach(node => {
      const el = document.createElement('div');
      if (node.type === 'dir') {
        const folder = document.createElement('div');
        folder.className = 'folder';
        folder.innerHTML = `<div class="title">ğŸ“ ${node.name}</div>`;
        folder.addEventListener('click', (ev)=>{ ev.stopPropagation(); const ch = el.querySelector('.children'); if (ch) ch.style.display = ch.style.display === 'none' ? 'block' : 'none'; });
        el.appendChild(folder);
        const children = document.createElement('div');
        children.className = 'children';
        renderTree(node.children || [], children);
        el.appendChild(children);
      } else {
        const file = document.createElement('div');
        file.className = 'file';
        file.textContent = 'ğŸ“„ ' + node.name;
        file.dataset.path = node.path;
        file.tabIndex = 0;
        file.setAttribute('role', 'treeitem');
        file.addEventListener('click', ()=> selectFile(node.path, file));
        file.addEventListener('keydown', (e)=> { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectFile(node.path, file); }});
        el.appendChild(file);
      }
      container.appendChild(el);
    });
  }

  // æ ¹æ® path ä» files map è·å–æ–‡æœ¬å¹¶æ¸²æŸ“
  function selectFile(relPath, el) {
    if (selectedFileEl) selectedFileEl.classList.remove('selected');
    selectedFileEl = el;
    el.classList.add('selected');

    const entry = files.get(relPath);
    if (!entry) { contentEl.innerText = 'æ–‡ä»¶ä¸å­˜åœ¨'; return; }
    renderMarkdown(entry.text);
    if (window.innerWidth <= 980) openMobileToc();
  }

  // æ¸²æŸ“ Markdown ä¸æ„å»º TOCï¼ˆåŒåŸé€»è¾‘ï¼‰
  let currentObserver = null;
  function renderMarkdown(md) {
    if (!contentEl) return;
    marked.setOptions({ gfm:true, breaks:false, smartLists:true, headerIds:false });
    const html = marked.parse(md);
    const safe = DOMPurify.sanitize(html, { ADD_ATTR: ['id'] });
    contentEl.innerHTML = safe;

    const headings = Array.from(contentEl.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    headings.forEach(h=>{
      const text = (h.textContent || '').trim();
      const base = text.slice(0,40);
      const encoded = encodeURIComponent(base).replace(/%/g,'-').toLowerCase();
      const slug = encoded || ('section-' + h.tagName.toLowerCase());
      let id = slug;
      let i = 1;
      while (contentEl.querySelector('#' + CSS.escape(id))) { id = `${slug}-${i}`; i++; }
      h.id = id;
    });

    let tocList = headings.filter(h => ['H2','H3','H4'].includes(h.tagName)).map(h => ({ text: h.textContent.trim(), level: parseInt(h.tagName.substring(1),10), id: h.id }));
    if (tocList.length === 0) tocList = headings.filter(h => h.tagName === 'H1').map(h => ({ text: h.textContent.trim(), level:1, id: h.id }));

    if (!tocEl) return;
    tocEl.innerHTML = '';
    if (tocList.length === 0){
      tocEl.textContent = 'æœ¬æ–‡æ— æ ‡é¢˜';
    } else {
      tocList.forEach(item=>{
        const a = document.createElement('a');
        a.href = '#' + item.id;
        a.textContent = item.text;
        a.className = 'level-' + item.level;
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const target = document.getElementById(item.id);
          if (!target) return;
          target.scrollIntoView({ behavior:'smooth', block:'start' });
          history.replaceState(null,'',`#${item.id}`);
          if (window.innerWidth <= 980) closeMobileToc();
        });
        tocEl.appendChild(a);
      });
    }

    if (window.hljs) {
      const blocks = contentEl.querySelectorAll('pre code');
      if (blocks.length) blocks.forEach(block => hljs.highlightElement(block));
    }

    const observeTags = tocList.some(i => i.level >= 2) ? ['H2','H3','H4'] : ['H1'];
    const observeHeadings = headings.filter(h => observeTags.includes(h.tagName));
    const tocMap = new Map();
    tocEl.querySelectorAll('a').forEach(a => tocMap.set(a.getAttribute('href').slice(1), a));

    if (currentObserver) { try { currentObserver.disconnect(); } catch(e){} currentObserver = null; }
    if (observeHeadings.length > 0) {
      currentObserver = new IntersectionObserver((entries)=>{
        const visible = entries.filter(e => e.isIntersecting).sort((a,b)=> a.target.getBoundingClientRect().top - b.target.getBoundingClientRect().top);
        const current = (visible[0] && visible[0].target.id) || null;
        if (!current) return;
        tocEl.querySelectorAll('a.active').forEach(a => a.classList.remove('active'));
        const link = tocMap.get(current);
        if (link) link.classList.add('active');
      }, { rootMargin: '0px 0px -70% 0px', threshold: 0.1 });
      observeHeadings.forEach(h => currentObserver.observe(h));
    }

    const initialHash = location.hash && location.hash.slice(1);
    if (initialHash){
      const tgt = document.getElementById(initialHash);
      if (tgt) tgt.scrollIntoView({ behavior:'auto', block:'start' });
    }
    updateMobileTocVisibility(tocList.length > 0);
  }

  function updateMobileTocVisibility(hasToc){
    if (!tocFab) return;
    tocFab.style.display = (window.innerWidth <= 980 && hasToc) ? 'inline-block' : 'none';
    if (!hasToc && tocEl) tocEl.textContent = 'æœ¬æ–‡æ— æ ‡é¢˜';
  }

  // æ„å»ºæ ‘å¹¶æ¸²æŸ“ï¼ˆä¾›æ–‡ä»¶å˜æ›´æˆ–åˆæ¬¡åŠ è½½è°ƒç”¨ï¼‰
  function buildTreeAndRender(){
    const model = buildTreeModel();
    renderTree(model);
  }

  // æ¸…ç©º
  clearBtn && clearBtn.addEventListener('click', ()=>{
    files.clear();
    selectedFileEl = null;
    fileTreeEl.innerHTML = 'å·²æ¸…ç©º';
    contentEl.innerHTML = 'è¯·é€šè¿‡å·¦ä¾§ã€Œé€‰æ‹©æ–‡ä»¶/ç›®å½•ã€æˆ–æ‹–æ”¾ Markdown æ–‡ä»¶åˆ°æ­¤é¡µé¢';
    tocEl.innerHTML = 'å½“å‰æœªåŠ è½½';
  });

  // æ–‡ä»¶é€‰æ‹©æŒ‰é’®ä¸å›é€€é€»è¾‘
  pickBtn && pickBtn.addEventListener('click', async ()=>{
    // ä¼˜å…ˆå°è¯•ä½¿ç”¨ File System Access API çš„ç›®å½•é€‰æ‹©
    if (window.showDirectoryPicker) {
      try {
        const dir = await window.showDirectoryPicker();
        await addFilesFromDirectoryHandle(dir);
        buildTreeAndRender();
        return;
      } catch (e) {
        // ç”¨æˆ·å–æ¶ˆæˆ–ä¸æ”¯æŒï¼Œå›é€€åˆ° input
      }
    }
    filePicker && filePicker.click();
  });

  filePicker && filePicker.addEventListener('change', async (e)=>{
    const list = Array.from(e.target.files || []);
    await addFilesFromFileList(list);
    filePicker.value = '';
  });

  // æ”¯æŒæ‹–æ”¾
  window.addEventListener('dragover', (e)=> e.preventDefault());
  window.addEventListener('drop', async (e)=> {
    e.preventDefault();
    const dt = e.dataTransfer;
    if (!dt) return;
    // è‹¥æœ‰ filesï¼Œä¼˜å…ˆä½¿ç”¨ FileListï¼ˆåŒ…å« webkitRelativePath è‹¥æ‹–å…¥ç›®å½•ï¼‰
    if (dt.files && dt.files.length) {
      await addFilesFromFileList(Array.from(dt.files));
      return;
    }
    // è‹¥ä½¿ç”¨ DataTransferItemList ä¸”åŒ…å« directory entriesï¼Œåˆ™è·³è¿‡ï¼ˆå¤æ‚ï¼Œäº¤ç»™ showDirectoryPickerï¼‰
  });

  // æœç´¢ï¼šæ—¢å¯æŒ‰æ–‡ä»¶åä¹Ÿå¯æŒ‰å†…å®¹åŒ¹é…
  if (searchEl) searchEl.addEventListener('input', ()=>{
    const q = searchEl.value.trim().toLowerCase();
    if (!q){ renderTree(buildTreeModel()); return; }
    const filtered = [];
    function walk(nodes){
      nodes.forEach(n=>{
        if (n.type === 'dir') {
          const clone = { ...n, children: []};
          walk(n.children || []);
          // we'll filter later by checking clone.children length
        } else {
          const text = (files.get(n.path) && files.get(n.path).text) || '';
          if (n.name.toLowerCase().includes(q) || text.toLowerCase().includes(q)) filtered.push(n);
        }
      });
    }
    // ç®€å•è¿‡æ»¤å®ç°ï¼šæ„å»º flat list then rebuild minimal tree with matching files
    const matches = [];
    for (const [p, meta] of files) {
      if (p.toLowerCase().includes(q) || meta.name.toLowerCase().includes(q) || meta.text.toLowerCase().includes(q)) matches.push(p);
    }
    // rebuild tree from matches
    const tempFiles = new Map();
    for (const m of matches) { tempFiles.set(m, files.get(m)); }
    const old = new Map(files);
    files.clear();
    for (const [k,v] of tempFiles) files.set(k,v);
    renderTree(buildTreeModel());
    files.clear();
    for (const [k,v] of old) files.set(k,v);
  });

  // å¯åŠ¨ï¼šåˆå§‹éšè— tocFab
  window.addEventListener('load', ()=> updateMobileTocVisibility(false));
})();
</script>
</body>
</html>
